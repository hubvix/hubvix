<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed de Videos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <style>
        /* Previous CSS remains unchanged */
    </style>
</head>
<body>
    <!-- Previous HTML structure remains unchanged -->
    <script>
        // Single VideoPlayerError class definition
        class VideoPlayerError extends Error {
            constructor(message, type) {
                super(message);
                this.name = 'VideoPlayerError';
                this.type = type;
            }
        }

        // Single CONFIG object definition
        const CONFIG = Object.freeze({
            allowedTypes: ['video/mp4', 'video/webm', 'video/ogg'],
            maxFileSize: 100 * 1024 * 1024, // 100MB
            uploadTimeout: 2000,
            successMessageDuration: 1500,
            icons: {
                play: '<i class="lucide-play"></i>',
                pause: '<i class="lucide-pause"></i>',
                volumeOn: '<i class="lucide-volume-2"></i>',
                volumeOff: '<i class="lucide-volume-x"></i>',
                maximize: '<i class="lucide-maximize"></i>',
                minimize: '<i class="lucide-minimize"></i>'
            }
        });

        // DOM Elements with error handling
        function getDOMElements() {
            const elements = {
                uploadBtn: document.getElementById('uploadBtn'),
                uploadModal: document.getElementById('uploadModal'),
                closeModal: document.getElementById('closeModal'),
                uploadForm: document.getElementById('uploadForm'),
                videoInput: document.getElementById('videoInput'),
                videoContainer: document.getElementById('videoContainer'),
                videoPlayer: document.getElementById('videoPlayer'),
                playPauseBtn: document.getElementById('playPauseBtn'),
                muteBtn: document.getElementById('muteBtn'),
                fullscreenBtn: document.getElementById('fullscreenBtn'),
                progressContainer: document.getElementById('progressContainer'),
                progressBar: document.getElementById('progressBar'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                volumeLevel: document.getElementById('volumeLevel')
            };

            // Verify all elements exist
            for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    throw new Error(`Required DOM element not found: ${key}`);
                }
            }

            return elements;
        }

        // Initialize player with proper error handling
        async function initializePlayer() {
            try {
                const elements = getDOMElements();
                const playerState = {
                    lastVolume: 1,
                    isUploading: false
                };

                // Event delegation for better performance
                document.addEventListener('click', (e) => {
                    const target = e.target;

                    // Handle video container clicks
                    if (target.closest('#videoContainer') && !target.closest('.video-controls')) {
                        togglePlay(elements.videoPlayer, elements.playPauseBtn);
                    }

                    // Handle modal close clicks
                    if (target === elements.uploadModal) {
                        closeUploadModal(elements, playerState);
                    }
                });

                // Initialize upload functionality
                initializeUpload(elements, playerState);

                // Initialize video controls
                initializeVideoControls(elements, playerState);

                // Initialize keyboard shortcuts
                initializeKeyboardShortcuts(elements);

                // Set initial volume display
                elements.volumeLevel.style.transform = `scaleX(${elements.videoPlayer.volume})`;

            } catch (error) {
                console.error('Failed to initialize player:', error);
                alert('Error initializing video player. Please refresh the page.');
            }
        }

        // Helper functions with proper error handling
        function initializeUpload(elements, playerState) {
            const { uploadBtn, uploadModal, closeModal, uploadForm, videoInput } = elements;

            uploadBtn.addEventListener('click', () => {
                if (!playerState.isUploading) {
                    uploadModal.classList.add('active');
                }
            });

            closeModal.addEventListener('click', () => {
                closeUploadModal(elements, playerState);
            });

            videoInput.addEventListener('change', (e) => handleFileSelect(e, elements, playerState));
            uploadForm.addEventListener('submit', (e) => handleFormSubmit(e, elements, playerState));
        }

        function initializeVideoControls(elements, playerState) {
            const { videoPlayer, playPauseBtn, muteBtn, fullscreenBtn, progressContainer, volumeLevel } = elements;

            // Add event listeners with proper error handling
            playPauseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePlay(videoPlayer, playPauseBtn);
            });

            muteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMute(videoPlayer, muteBtn, volumeLevel, playerState);
            });

            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFullscreen(elements.videoContainer, fullscreenBtn);
            });

            // Progress bar handling
            videoPlayer.addEventListener('timeupdate', () => updateProgress(videoPlayer, elements.progressBar));
            progressContainer.addEventListener('click', (e) => handleProgressClick(e, videoPlayer, progressContainer));
        }

        // Initialize the player when DOM is ready
        document.addEventListener('DOMContentLoaded', initializePlayer);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer && videoPlayer.src) {
                URL.revokeObjectURL(videoPlayer.src);
            }
        });
    </script>
</body>
</html>
